# Ralph Progress Log
Started: 2026-02-04 — v1.3 cleanup-and-fixes
---

## Codebase Patterns
- verbatimModuleSyntax is ON — use `import type` for ALL type-only imports (e.g. `import type { CalendarEvent } from '../data/mockEvents.ts'`)
- noUnusedLocals + noUnusedParameters are ON — zero unused variables or parameters allowed anywhere in the codebase
- Zustand store actions are defined inline inside the create()(persist((set) => ({ ... }))) call in src/store/useAppStore.ts. Follow the existing patterns exactly:
  - update action: (id, updates) => set((state) => ({ items: state.items.map(i => i.id === id ? { ...i, ...updates } : i) }))
  - remove action: (id) => set((state) => ({ items: state.items.filter(i => i.id !== id) }))
  - Example: updateFriend, updateGroup, removeLocalEvent already follow this pattern — copy their shape for new actions
- CalendarEvent interface lives in src/data/mockEvents.ts. The store imports it with `import type { CalendarEvent } from '../data/mockEvents.ts'`
- Modal pattern: fixed inset-0 overlay with bg-black/40, white rounded-2xl card, max-w-lg, centered via flex items-center justify-center
- Input styling across the app: border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300
- Orange (#F97316) is the primary accent. Active/selected states use bg-orange-500 text-white. Segmented controls (like ViewToggle and the importance picker in CreateEventModal) use this pattern.
- Backend is Express 5 with CommonJS modules (not ESM). type: commonjs in backend/package.json. Routes go in backend/routes/ and are registered in backend/server.ts.
- Backend typecheck command: cd backend && npx tsc --noEmit (has its own tsconfig.json)
- Frontend build + typecheck command: npm run build (runs tsc -b && vite build)
- Google OAuth helper: getValidClient(req) in backend/routes/google.ts returns an authenticated OAuth2 client or null. Every Google Calendar route must call it first and return 401 if null.
- Notification pattern: addNotification({ id: `notif-<unique>`, fromName: 'Source', message: 'text', read: false, createdAt: new Date() })
- DashboardPage assembles allEvents = [...mockEvents, ...googleCalendar.events (deduped by pushedGoogleIds), ...localEvents]. mockEvents is []. expandedEvents = expandRecurrence(allEvents, rangeStart, rangeEnd). filteredEvents applies searchQuery filter. filteredEvents flows to CalendarGrid.
- CalendarGrid receives events[] and onDayClick. DayView + WeekView render event blocks as absolutely positioned colored divs. MonthView renders titled event pills (max 2 visible) + "+N more" overflow link. Clicking a day cell or "+N more" opens a fixed-position popover (not CreateEventModal directly).
- Frosted-glass card pattern: bg-white/90 backdrop-blur-sm shadow-sm rounded-xl border border-gray-200 overflow-hidden — used by CalendarGrid, NotificationPanel, UpcomingEvents, AISuggestionCard. All sidebar widgets MUST use this exact class set.
- Vite proxy is already configured in vite.config.ts: /api → http://localhost:3001 with changeOrigin: true. Do NOT add a duplicate.
- Axios is used for all HTTP calls from the frontend. Backend runs on port 3001.
- Express 5 route params: req.params.id is typed as string by default. For async route handlers, Express 5 catches rejected promises automatically — no need to wrap in try/catch just for error forwarding.
- Google Calendar API: calendar.events.insert (create), calendar.events.update (edit), calendar.events.delete (remove). All use calendarId: 'primary'.
- Token store is file-backed: backend/routes/google.ts reads/writes tokens.json via loadTokens() / saveTokens(). tokenStore is a module-level Record<string, TokenBundle>.
- dotenv in backend/server.ts loads via path.resolve(__dirname, '..', '.env.local') — fixed in v1.3 US-005.
- deleteMessage(conversationId, messageId) action in store; trash button on hover for own messages (v1.3 US-004).
- deleteConversation(conversationId) action in store; trash button in conversation header with confirm dialog (v1.4 US-002).
- GifPicker no longer ships a hardcoded Giphy key. Missing key → "not configured" message; fetch failure → visible error (v1.3 US-006).
- GET /api/google/status returns { configured, connected } for OAuth diagnostics (v1.3 US-005).
- GET /api/google/auth guards against empty CLIENT_ID / CLIENT_SECRET with a 500 JSON error (v1.3 US-005).
- expandRecurrence.ts exports getVisibleRange(view, date) → [Date, Date] and expandRecurrence(events, start, end) → CalendarEvent[]. Recurring instances get IDs like "originalId__rN". DashboardPage splits on '__r' to resolve base IDs for edit/delete. (v1.4 US-001)
- Notification cap: all three notification-mutation paths in the store (addNotification, createSyncProposal, addTextInvite) apply .slice(0, 20). They do NOT all go through addNotification — two build arrays inline. (v1.4 US-003)
- hasConflict in mockAI.ts is exported. CreateEventModal does its own .filter() (not hasConflict) because it needs the conflicting event objects for the warning message, not just a boolean. (v1.4 US-006)
- CalendarGrid "Today" button: isToday is view-aware. Day → isSameDay. Week → getWeekDays(selectedDate).some(isSameDay). Month → month+year comparison. Both helper functions already exist in CalendarGrid. (v1.4 US-004)
- CalendarGrid MonthView popover: fixed-position centered card (z-50) + backdrop div (z-40, fixed inset-0). Backdrop onClick closes. popoverDay state is internal to MonthView. Popover data (popEvents, popDayLabel) computed unconditionally — cheap .filter(), no IIFE needed. (v1.4 US-007)
- CalendarGrid outer wrapper toggles overflow: overflow-visible when calendarView === 'month', overflow-hidden otherwise. This keeps rounded-corner clipping for day/week scrolling views while allowing the month popover to render freely. (v1.4 US-007)
- UpcomingEvents widget receives allEvents (pre-expansion) so recurring events appear once at their base date only. If the base date is in the past but recurrences are upcoming, they will not show — acceptable per spec. (v1.4 US-008)
- DashboardPage search: searchQuery state → case-insensitive title filter over expandedEvents → filteredEvents flows to CalendarGrid. Search does not affect event creation (onDayClick is independent). (v1.4 US-009)
- IDE diagnostics from the PostToolUse:Edit hook are frequently stale — they do not reflect edits that just completed. Always trust `npm run build` as the source of truth, not the IDE warnings.

## v1.3 Completion — 2026-02-04
All 6 stories shipped and passing:
  US-001 Strip placeholder data (notifications, friends, groups, conversations → [])
  US-002 Remove mock events + auto-reply simulation
  US-003 Replace 3-tier importance with 5-tier schedule priority
  US-004 Add deleteMessage action + hover trash button on own messages
  US-005 Harden Google OAuth: __dirname dotenv, /status endpoint, /auth 500 guard
  US-006 GIF picker: remove hardcoded key, surface missing-key + fetch-error states

## v1.4 Completion — 2026-02-04
All 9 stories shipped and passing:
  US-001 Expand recurring events into visible-range instances
  US-002 Add deleteConversation action and trash button in conversation header
  US-003 Cap notifications array at 20, auto-dismiss older
  US-004 Add Today jump button to calendar nav header
  US-005 Wire localEvents + googleCalendar into AI Planner
  US-006 Show conflict warning banner in create/edit modal
  US-007 Month view day-events popover
  US-008 Upcoming events widget in dashboard sidebar
  US-009 Search bar that filters calendar events by title
---

## 2026-02-05 - US-001
- Implemented FilterChips.tsx: pill chips per unique event color, sorted alphabetically by hex string, with colored circle + event count, active/inactive styles, and a Clear link
- Wired into DashboardPage: activeColors state, colorFilteredEvents derivation, filter chain order is color → search, FilterChips rendered below controls row
- **Learnings for future iterations:**
  - Filter chain order in DashboardPage is now: expandedEvents → colorFilteredEvents → (sourceFilteredEvents per US-002) → filteredEvents (search). Each new filter inserts between the previous and search.
  - FilterChips receives expandedEvents (pre-filter) so chip counts reflect all events regardless of active filters
  - No test script in this project — quality gate is build + lint only
  - Pre-existing lint errors exist in backend/middleware/errorHandler.ts, backend/routes/google.ts, src/components/GifPicker.tsx, src/pages/AIPlannerPage.tsx — do not attempt to fix unless assigned
---

## 2026-02-05 - US-002
- Implemented source filter segmented control (All / Local / Google) inline in DashboardPage controls row
- Added sourceFilter state typed as 'all' | 'local' | 'google', defaulting to 'all'
- Segmented control uses ViewToggle's exact className pattern (flex bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden; active bg-orange-500 text-white; inactive text-gray-600 hover:bg-gray-50)
- Google button only rendered when googleCalendar.isConnected is true
- Filter chain is now: expandedEvents → colorFilteredEvents → sourceFilteredEvents → filteredEvents (search)
- Files changed: src/pages/DashboardPage.tsx
- **Learnings for future iterations:**
  - Segmented controls are inlined per the PRD notes — do not extract shared components unless explicitly asked
  - The conditional spread pattern `['all', 'local', ...(condition ? ['google'] : [])] as Type[]` works cleanly for dynamic button sets with capitalize text rendering
  - Lint gate: all 6 errors are pre-existing (backend + GifPicker + AIPlannerPage), no new errors introduced
---

## 2026-02-05 - US-002
- Implemented source filter segmented control (All / Local / Google) in dashboard controls row
- Files changed: src/pages/DashboardPage.tsx (added sourceFilter state, segmented control UI, sourceFilteredEvents derivation)
- Filter chain: color → source → search (applied in correct order per spec)
- Google button conditionally rendered based on googleCalendar.isConnected
- Segmented control uses inline ViewToggle className pattern (no shared component extracted per notes)
- **Learnings for future iterations:**
  - US-002 was partially implemented in a previous iteration's working tree; detected by checking git diff before starting
  - The filter pipeline order (color → source → search) is established; future filter additions go between source and search or at the end
  - capitalize CSS class handles label casing for the segmented control buttons
---
